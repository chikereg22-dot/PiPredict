<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PiPredict - Predict & Win Pi!</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f8ff; padding: 20px; }
    button { padding: 12px 24px; margin: 10px; background: #ff4500; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #e03e00; }
    .match { border: 1px solid #ccc; margin: 20px auto; padding: 15px; max-width: 400px; border-radius: 12px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #app { display: none; }
    .premium { background: gold; color: black; }
    #leaderboard { margin: 20px; }
  </style>
</head>
<body>
  <h1>PiPredict: NBA & Football Predictions</h1>
  <button onclick="authenticate()">Login with Pi</button>
  <p id="user"></p>

  <div id="app">
    <button id="subscribeBtn" class="premium" onclick="subscribe()">Subscribe Premium (0.5 Pi/month)</button>
    <p id="premiumStatus"></p>

    <h2>Live Matches</h2>
    <div id="matches"></div>

    <h2>Leaderboard</h2>
    <div id="leaderboard"></div>
  </div>

  <script>
    let authUser = null;

    async function authenticate() {
      try {
        const scopes = ['username', 'payments'];
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        authUser = auth.user;
        document.getElementById('user').innerText = `Welcome, ${authUser.username}!`;
        document.getElementById('app').style.display = 'block';
        loadUserInfo();
        loadMatches();
        loadLeaderboard();
      } catch (err) {
        alert('Auth failed: ' + err.message);
      }
    }

    function onIncompletePaymentFound(payment) {
      console.log('Incomplete payment:', payment);
    }

    async function loadUserInfo() {
      const res = await fetch(`/user/${authUser.uid}`);
      const user = await res.json();
      document.getElementById('premiumStatus').innerText = user.isPremium 
        ? `Premium until ${new Date(user.premiumUntil).toLocaleDateString()}` 
        : 'Subscribe for full access!';
      if (user.discountCodes.length > 0) {
        alert(`Use discount: ${user.discountCodes[0]} for 10% off sub!`);
      }
    }

    async function subscribe() {
      const discountCode = prompt('Enter discount code (if any):');
      const amount = discountCode ? 0.45 : 0.5;

      try {
        const payment = {
          amount,
          memo: `PiPredict Premium${discountCode ? ' (Discounted)' : ''}`,
          metadata: { action: 'subscribe', discountCode },
          uid: authUser.uid
        };

        const txid = await Pi.createPayment(payment, {
          onReadyForServerApproval: (pid) => approvePayment(pid, 'subscribe'),
          onReadyForServerCompletion: (pid, tx) => completePayment(pid, tx, 'subscribe'),
          onCancel: () => alert('Cancelled'),
          onError: (err) => alert('Error: ' + err.message)
        });
      } catch (err) {
        alert('Payment failed: ' + err.message);
      }
    }

    async function approvePayment(paymentId, type) {
      await fetch('/approve-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId, type })
      });
    }

    async function completePayment(paymentId, txid, type) {
      const res = await fetch('/complete-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId, txid, userId: authUser.uid, type })
      });
      if (res.ok) {
        alert('Subscription active!');
        loadUserInfo();
      }
    }

    async function loadMatches() {
      const res = await fetch('/matches');
      const matches = await res.json();
      const container = document.getElementById('matches');
      container.innerHTML = '';
      matches.forEach(m => {
        const div = document.createElement('div');
        div.className = 'match';
        div.innerHTML = `
          <b>${m.home} vs ${m.away} (${m.sport.toUpperCase()})</b><br>
          <small>${new Date(m.date).toLocaleString()}</small><br>
          <button onclick="join('${m.matchId}', 'home')">Home Win (0.5 Pi)</button>
          <button onclick="join('${m.matchId}', 'away')">Away Win (0.5 Pi)</button>
          ${m.sport === 'football' ? `<button onclick="join('${m.matchId}', 'draw')">Draw (0.5 Pi)</button>` : ''}
          <p>Pool: ${m.pool} Pi</p>
        `;
        container.appendChild(div);
      });
    }

    async function join(matchId, prediction) {
      const res = await fetch('/join-challenge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: authUser.uid, matchId, prediction })
      });
      const data = await res.json();
      if (data.success) {
        alert('Joined! Pool now: ' + data.pool + ' Pi');
        loadMatches();
      } else {
        alert('Error: ' + data.error);
      }
    }

    async function loadLeaderboard() {
      const res = await fetch('/leaderboard');
      const top = await res.json();
      const lb = document.getElementById('leaderboard');
      lb.innerHTML = top.map((u, i) => `${i+1}. ${u.username} - ${u.wins} wins<br>`).join('');
    }

    // Check premium hourly
    setInterval(loadUserInfo, 3600000);
  </script>
</body>
</html>